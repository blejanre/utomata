<!--

	TODO:

	- color code all utomata keywords
	- use url parameters in php
	- add bulb for errors
	- add an open recent menu
	- tidy up code
	- add watermark link to utomata file exports
	- opt to make exports standaline - look into embeding the minified library in each exported file
	- opt to name file when saving
	- add full screen mode
	
 -->

<!DOCTYPE html>
<html lang="en">
	<head>
		<title>utomata editor</title>
		<meta charset="utf-8">
		<style media="screen">
		*,*::before,*::after {box-sizing: border-box;margin: 0;padding: 0;}
		body{background:#AAA;font-family: Ariel, Helvetica, san-Serif, monospace; font-size: 12px;}
		#mainCanvas{display:block; image-rendering: pixelated;image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: crosshair;}
		#panel{
		  resize: both;
		  border: 1px solid rgba(127,127,127, 0.3);
		  border-top: none;
		  border-left: none;
			overflow: auto;
		  min-width: 230px;
		  min-height: 42px;
			max-width: 100vw;
		  max-height: 100vh;
			width: 320px;
			height: 480px;
			background: #EEE; position:fixed; top:0; left:0;
			z-index: 1;
		}

		#infoPanel{
			background: #EEE;
			position: sticky;
			width: 100%;
			font-size: 10px;
			border-top: 1px solid rgba(127,127,127, 0.3);
			padding:4px;
		}

		.ace_editor{
		  background: none;

		}
		.ace-container{
			margin: 0 0 0 16px;
			overflow: auto;
			width: calc(100% - 16px);
			height: calc(100% - 64px);
		}
		#header{background: white; z-index: 100; position: sticky; top: 0; border: 1px solid #999;  width: 100%;  }
		#header h1{ font-size: 12px; font-weight: bold; text-align: center;}

		.titlebar{ color: white; background: #0001A8;padding: 2px 25px; border-bottom: 2px solid #000;overflow: hidden;}
		.toolbar{ color: black; width: 700px; overflow: hidden;}
		.headerItem {display: inline-block; cursor: pointer; padding: 2px 16px}
		.dropdownItem input{ text-align: center; border: none; color:inherit; background:none;font-family: inherit; font-size: 11px}
		.noselect {-webkit-user-select: none;user-select: none;}

		.menuBar{
			background-color: #fff;
			border: 1px solid #ccc;
			height: 20px;
		}

#menu{
	position: fixed;
	top: 22px;
  display:flex;
	z-index: 1000;
}

.menuBtn {
  cursor: pointer;
  font-family: Arial, Helvetica, Sans-Serif;
	font-size: 12px;
	padding: 2px 16px;
	position: relative;
}

.dropdown-menu {
  position: absolute;
  z-index: 1000;
	display: none;
  min-width: 160px;
  padding: 5px 0;
  margin: 2px 0 0 0 ;
  list-style: none;
  background-color: #fff;
  border: 1px solid #ccc;
  background-clip: padding-box;
}
.dropdown-menu a {
	text-decoration: none;
}
.dropdown-menu a li {
	font-size: 12px;
	font-family: arial,sans-serif;
	color: #222;
	padding: 5px 15px;
}

.menuBtn:hover, .dropdown-menu a li:hover{
  color: white;
	background: #0001A8;
}



		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.min.js" type="text/javascript">	</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/mode-glsl.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/theme-terminal.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/theme-iplastic.min.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/theme-kuroir.min.js" type="text/javascript"></script>

		<script src="utomata.js"></script>
	</head>
	<body ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">



			<div id="menu">
			  <div>
			      <div class="menuBtn">File</div>
			      <ul class="dropdown-menu">
			        <a class="dropdownItem" href="#"><li>New</li></a>
			        <a class="dropdownItem" href="#"><li>Duplicate</li></a>
			        <hr>
			        <a class="dropdownItem" href="#"><li>Examples...</li></a>
							<hr>
			        <a class="dropdownItem" id="inputSave" href="#"><li>Save (HTML)</li></a>
			        <a class="dropdownItem" href="#"><li>Export (png)</li></a>
			      </ul>
			  </div>

			  <div>
			      <div class="menuBtn">Set</div>
			      <ul class="dropdown-menu">
			        <a class="dropdownItem" id="inputConfig" href="#"><li>config()</li></a>
			        <a class="dropdownItem"  href="#"><li id="inputRun">stop()</li></a>
			        <hr>
			        <a class="dropdownItem" href="#"><li>width( <input size="4" type="text" id="inputWid" value="1024"> )</li></a>
			        <a class="dropdownItem" href="#"><li>height( <input size="4" type="text" id="inputHei" value="1024"> )</li></a>
			        <a class="dropdownItem" href="#"><li>fps( <input size="2" type="text"  id="inputFps" name="" value="60"> )</li></a>
			        <a class="dropdownItem" href="#"><li>zoom( <input size="2" type="text"  id="inputZoom" name="" value="1"> )</li></a>
			      </ul>
			    </div>

			  <div>
			      <div class="menuBtn">View</div>
			      <ul class="dropdown-menu">
			        <a class="dropdownItem"  href="#"><li>Fullscreen</li></a>
			        <a class="dropdownItem"  href="#"><li>Hide code</li></a>
			        <a class="dropdownItem"  href="#"><li>Editor font-size</li></a>
			      </ul>
			  </div>

			    <div>
			      <div class="menuBtn">Help</div>
			      <ul class="dropdown-menu">
			        <a class="dropdownItem"  href="#"><li>Programming guide...</li></a>
			        <a class="dropdownItem"  href="#"><li>Language reference...</li></a>
			        <hr>
			        <a class="dropdownItem"  href="#"><li>About...</li></a>
			        <a class="dropdownItem"  href="#"><li>Source...</li></a>
			      </ul>
			  </div>
			</div>


			<div id="panel">
				<div id="header">
					<div class="titlebar">
						<h1>utomata editor v0.1</h1>
					</div>
					<div class="menuBar"></div>
				</div>

<div class="ace-container">


		<textarea spellcheck="false" id="utoPgm">
// reset the system to random binary states
config = vec( rnd(random()) );
// run conwway's game of life
V = add(eql(3.0, V9), mlt(eql(4.0, V9), V));
		</textarea>
		</div>
		<div id="infoPanel" class="noselect"></div>
</div>


		<script>

		//toggle dropdown menu open/close
function toggle(e) {

  e.stopPropagation();
  closeAll();
  var btn=this;
  var menu = btn.nextSibling;

  while(menu && menu.nodeType != 1) {
     menu = menu.nextSibling
  }
  if(!menu) return;
  if (menu.style.display !== 'block') {
    menu.style.display = 'block';
  }  else {
    closeAll();
    menu.style.display = 'none';
  }

};

function closeAll() {
   document.querySelectorAll(".dropdown-menu").forEach(function(menu){
     menu.style.display='none';
  });
};

window.addEventListener("DOMContentLoaded",function(){
  document.querySelectorAll(".menuBtn").forEach(function(btn){
     btn.addEventListener("click",toggle,true);
  });
  document.querySelectorAll(".dropdownItem").forEach(function(item){
     item.addEventListener("click",function(e){
       e.stopPropagation();
     });
  });
});



window.onclick=function(event){
  closeAll();
  // if (toClose){
  // closeAll.call(event.target);
  // }
};


		var isRunning = true;

		var editorTimeOut;
		var editor = ace.edit('utoPgm');
		editor.setTheme("ace/theme/terminal");
		editor.session.setMode("ace/mode/glsl");

		editor.setOption("showGutter", false);
		//editor.setTheme("ace/theme/terminal");
		editor.setTheme("ace/theme/iplastic");

	  editor.session.setMode("ace/mode/glsl");
	  editor.renderer.setShowPrintMargin(false);
	  editor.setOption("showInvisibles", false);
	  editor.setOption("selectionStyle", "text");
	  editor.setOption("highlightActiveLine", false);
	  editor.setOption("highlightSelectedWord", true);
	  editor.setOption("cursorStyle", "wide");
	  editor.setOption("useSoftTabs", true);
	  editor.setOption("tabSize", 3);
	  editor.setOption("fontSize", 14);
	  editor.setAutoScrollEditorIntoView(true);
	  editor.setOption("maxLines", "Infinity");


		//var rules = editor.session.$mode.$highlightRules.getRules();
		//console.log(rules);
		// TODO: add utomata keywords

		// for (var stateName in rules) {
		// 		if (Object.prototype.hasOwnProperty.call(rules, stateName)) {
		// 				rules[stateName].unshift({
		// 						token: 'my_token',
		// 						regex: 'two'
		// 				});
		// 		}
		// }

		// force recreation of tokenizer
		// editor.session.$mode.$tokenizer = null;
		// editor.session.bgTokenizer.setTokenizer(editor.session.$mode.getTokenizer());
		// force re-highlight whole document
		// editor.session.bgTokenizer.start(0);

		var useLocalStorage = true;
		var uto;
		var pgm = "V = V;";
		var wid, hei, zoom, fps;

		wid = document.getElementById("inputWid").value;
		hei = document.getElementById("inputHei").value;
		zoom = document.getElementById("inputZoom").value;
		fps = document.getElementById("inputFps").value;

		uto = new utomata( 1024, 1024);

		if (typeof(Storage) !== "undefined" && useLocalStorage) {
      if(localStorage.getItem("utomataProgram") !== null){
        // load last program
        pgm = localStorage.getItem("utomataProgram");
      }
			if(localStorage.getItem("utomataWidth") !== null){
        // load last program
        wid = localStorage.getItem("utomataWidth");
				document.getElementById("inputWid").value = wid;
      }
			if(localStorage.getItem("utomataHeight") !== null){
        // load last program
        hei = localStorage.getItem("utomataHeight");
				document.getElementById("inputHei").value = hei;
      }
			if(localStorage.getItem("utomataZoom") !== null){
        // load last program
        zoom = localStorage.getItem("utomataZoom");
				document.getElementById("inputZoom").value = zoom;
      }
			if(localStorage.getItem("utomataFps") !== null){
        // load last program
        fps = localStorage.getItem("utomataFps");
				document.getElementById("inputFps").value = fps;
      }
		}

		editor.setValue(pgm);
		editor.clearSelection();
		reset();

		function reset(){
			uto.size( wid, hei);
			uto.run( editor.getValue() );
			uto.zoom(zoom);
			uto.fps(fps);
			uto.config();
		}

			// uto.stop();
			// uto.go();
			// uto.config("V = vec4(1.0, 0, 0, 1.0)");

			// uto.getErrors();

			// TODO:
			// uto.input( tex );
			// uto.var("key", value);

			// uto.getVar("key");
			// uto.getInfo();

			document.getElementById("mainCanvas").addEventListener("mousemove", function(e){
				var info = "( " +uto.getMouseX() + " , " + uto.getMouseY() + " )";
				document.getElementById("infoPanel").innerHTML = info;
			})

			document.getElementById("inputConfig").addEventListener('click', function(){
				uto.config();
			});

			document.getElementById("inputRun").addEventListener('click', function(){
				if(isRunning){
					uto.stop();
					this.innerHTML = "run()";
					isRunning = false;
				}else{
					uto.run();
					this.innerHTML = "stop()";
					isRunning = true;
				}
			});

			document.getElementById("inputZoom").addEventListener('change', function(){
				zoom = this.value;
				uto.zoom(zoom);
			});
			document.getElementById("inputFps").addEventListener('change', function(){
				fps = this.value
				uto.fps(fps);
			});
			document.getElementById("inputWid").addEventListener('change',function(){
				wid = this.value;
				reset();
			});
			document.getElementById("inputHei").addEventListener('change',function(){
				hei = this.value;
				reset();
			});




			document.getElementById("panel").addEventListener('mouseup', function(e){
			  editor.resize();
			});


			document.getElementById("inputSave").addEventListener('click', function(){

				var data = "<!DOCTYPE html><html lang='en' dir='ltr'><head><meta charset='utf-8'>";
				data += '<style media="screen">*,*::before,*::after {box-sizing: border-box;margin: 0;padding: 0;}body{background:#222;}img, canvas{display:block; image-rendering: pixelated;image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;}</style>';
				data += "<" + "script src='utomata.js'></"+"script></head><body><pre style='display:none;' id='utoPgm'>";

				data +=  editor.getValue();

				data += "</pre></body><"+"script type='text/javascript'>";
				data += 'var uto;uto = new utomata(' + wid + ', ' + hei + ');';
				data += 'uto.zoom(' + zoom + ');';
				data += 'uto.fps(' + fps + ');';
				data += 'uto.run(document.getElementById("utoPgm").innerHTML);';
				data += "</" + "script></html>";

				var d = new Date();
				var ds = d.getFullYear() + '-' + d.getMonth() + '-' + d.getDay() + '-' + d.getHours() + '-' + d.getMinutes() + '-' + d.getSeconds();
				var filename = "utoPgm-" + ds + ".html"
				var file = new Blob([data], {type: "text/plain"});
				if (window.navigator.msSaveOrOpenBlob) // IE10+
						window.navigator.msSaveOrOpenBlob(file, filename);
				else { // Others
						var a = document.createElement("a"),
						url = URL.createObjectURL(file);
						a.href = url;
						a.download = filename;
						document.body.appendChild(a);
						a.click();
						setTimeout(function() {
								document.body.removeChild(a);
								window.URL.revokeObjectURL(url);
						}, 0);
				}
			});


			editor.getSession().on("change", function(){
				if(isRunning){
					clearTimeout(editorTimeOut);
					editorTimeOut = setTimeout(function(){
							uto.run( editor.getValue() );
					}, 300);
				}
			});



			// SAVE CAMVAS AS PNG IN NEW TAB
			function saveImage(fileName, returnType) {
			  // if(!isRunning){
			  //   return;
			  // }
			  var dataURL = document.getElementById("utomataCanvas").toDataURL("image/png");

			  // The returnType argument specifies how to get the
			  // the image.  'obj' will set the source to an image element.
			  // 'window' will open a new window and display the image.
			  // 'download' will prompt the user to save the image.

			  switch(returnType) {
			    case 'obj':
			      var imgObj = new Image();
			      imgObj.src = dataURL;
			      document.getElementById('imageContainer').appendChild(imgObj);
			      break;
			    case 'window':
			      window.open(dataURL, "Canvas Image");
			      break;
			    case 'download':

			      var dlLink = document.createElement('a');
			      dlLink.download = fileName;
			      dlLink.href = dataURL;//dataURL.replace("image/png", "image/octet-stream");
			      dlLink.dataset.downloadurl = ["image/png", dlLink.download, dlLink.href].join(':');

			      document.body.appendChild(dlLink);
			      dlLink.click();
			      document.body.removeChild(dlLink);

			      break;
			  }
			}


			function dropHandler(ev) {
			  console.log('File(s) dropped');

			  // Prevent default behavior (Prevent file from being opened)
			  ev.preventDefault();

			  if (ev.dataTransfer.items) {
			    // Use DataTransferItemList interface to access the file(s)
			    for (var i = 0; i < ev.dataTransfer.items.length; i++) {
			      // If dropped items aren't files, reject them
			      if (ev.dataTransfer.items[i].kind === 'file') {
			        var file = ev.dataTransfer.items[0].getAsFile();

			        var extension = file.name
			        var reader = new FileReader();

			        let ext = file.name.split('.').pop().toLowerCase();
			        if(ext == 'js'){
			          reader.readAsText(file,"UTF-8");
			        }else if(ext == 'html'){
			          reader.onload = function(event) {

			            let _script = getTagContent(event.target.result, 'utoPgm');

			            if(_script == ""){
			              alert('Error loading file');
			            }else{
			                editor.setValue(_script, -1);
			            }
			          }
								reader.readAsText(file,"UTF-8");

			        }else if(ext == 'png' || ext == 'jpg'){
			          var img = document.createElement("img");
			          img.classList.add("hidden");
			          img.file = file;

			          reader.onload = (
			            function (aImg) { return function (e) {
			             aImg.src = e.target.result;
			             uto.input(aImg);
									 wid = uto.getWidth();
									 hei = uto.getHeight();
			             reset();
			            };
			          })(img);
			          reader.readAsDataURL(file);
			        }
			      }
			    }
			  } else {
			    // Use DataTransfer interface to access the file(s)
			    // for (var i = 0; i < ev.dataTransfer.files.length; i++) {
			    //   var file = ev.dataTransfer.files[0].getAsFile();
			    //   // same as above?
			    // }
			  }
			}

			function getTagContent (html, id){

			    var temporalDivElement = document.createElement("div");

			    temporalDivElement.innerHTML = html;
			    let res = temporalDivElement.querySelectorAll("#" + id)[0];
			    if(typeof res === "undefined"){
			      return "";
			    }
			    return res.innerHTML;
			}

			function dragOverHandler(ev) {
			  // Prevent default behavior (Prevent file from being opened)
			  ev.preventDefault();
			}


			window.onbeforeunload = function(){
			  // Store current state
			  if (typeof(Storage) !== "undefined") {
			    localStorage.setItem("utomataProgram", editor.getValue());
					localStorage.setItem("utomataWidth", wid);
					localStorage.setItem("utomataHeight", hei);
					localStorage.setItem("utomataZoom", zoom);
					localStorage.setItem("utomataFps", fps);
			  }

			  // keeping the program so no real need for this:
			  //return 'Are you sure you want to leave?';
			};




		</script>

	</body>
</html>
